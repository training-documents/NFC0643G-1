

# 実用的な企業ネットワークを構成する
---


## 演習の前提条件  
- Linux1のWebサーバー(NGINX)が構成済みであること
- Linux1のDNSサーバー(BIND)が構成済みであること
- Windows Server 2の Webサーバー(IIS)が構成済みであること
- Windows Server 2の DNSサーバーが構成済みであること

## 演習における役割と、環境のパラメータ
- X: ご自身のPod番号
- Router1: Router1
- Router2: Router2
- Network1: 10.X.1.0/24
- Network2: 10.X.2.0/24
- Network3: 10.X.3.0/24


## 注意
- 手順例の画像は<B>pod255</B>に準拠したパラメータのものです
- 手順内の<B>X</B>表記はご自身のpod番号に読み替えてください

---

# パケットフィルタ実装前の動作確認

1. Linux2の管理画面に接続する  

1. Linux2からWindows Server 1にDNS問い合わせができることを確認する  
    1. Linux2のコマンドラインで以下のコマンドを実行し、nslookupツールを開始する  
        ＞ ***nslookup***    

        ```
        [admin@linux2 ~]$ nslookup
        > 
        ```

    1. Linux2のコマンドラインのnslookupツールで以下のコマンドを実行し、Windows Server 1に "Web1.example.local." の名前解決要求を送信できることを確認する  
        ＞ ***server 10.X.1.104***  
        ＞ ***Web1.example.local.***   
        ＞ ***exit***   

            ```
            > server 10.255.1.104
            Default server: 10.255.1.104
            Address: 10.255.1.104#53
            > 
            > Web1.example.local.
            Server:10.255.1.104
            Address:10.255.1.104#53

            Web1.example.local canonical name = WSrv2-230802255.example.local.
            Name:WSrv2-230802255.example.local
            Address: 10.255.2.105
            > 
            > exit
            [admin@linux2 ~]$ 
            ```


1. Linux2からLinux1のWebサービスに接続できることを確認する  

    1. Linux2の管理画面に接続する  

    1. Linux2のコマンドラインで以下のコマンドを実行し、Linux1のWebサービスに接続できることを確認する  
        ＞ ***`wget http://10.X.1.102/index.html`***  
        ＞ ***ls***  
        ＞ ***cat index.html***

        ```
        [admin@linux2 ~]$ wget http://10.255.1.102/index.html
        --2023-09-25 04:45:01--  http://10.255.1.102/index.html
        Connecting to 10.255.1.102:80... connected.
        HTTP request sent, awaiting response... 200 OK
        Length: 105 [text/html]
        Saving to: ‘index.html’

        100%[======================================================>] 105         --.-K/s   in 0s      

        2023-09-25 04:45:01 (7.76 MB/s) - ‘index.html’ saved [105/105]

        [admin@linux2 ~]$ 
        [admin@linux2 ~]$ ls -l
        total 8
        -rw-rw-r--. 1 admin admin 105 Sep  5 15:13 index.html
        -rw-rw-r--. 1 admin admin 133 Aug 23 02:52 web1
        [admin@linux2 ~]$ 
        [admin@linux2 ~]$ cat index.html 
        <html>

        Why was nginx so goot at yoga? <br>
        It mastered the art of staying flexible under load.

        </html>
        [admin@linux2 ~]$ 
        ```

        <kbd>![img](image/16/12.png)</kbd>  



<!--

1. DNS動作確認の準備をする  
    1. nslookupを実行する
    ＞ ***nslookup***


    > 【補足】  
    > nslookupが実行できない場合は以下の手順を実行し、nslookupツールをインストールする 
    > ＞ sudo yum -y install bind-utils
    > ＞ yum list installed | grep bind-utils


        <details>
        <summary>[参考]yum実行時のログ出力例 (クリックで表示):</summary>

            ```
            [admin@linux2 ~]$ sudo yum -y install bind-utils
            Loaded plugins: langpacks
            Resolving Dependencies
            ーー> Running transaction check
            ーーー> Package bind-utils.x86_64 32:9.11.4-26.P2.el7_9.14 will be installed
            ーー> Finished Dependency Resolution

            Dependencies Resolved

            ========================================================================================================================================================================================
            Package                                 Arch                                Version                                               Repository                                      Size
            ========================================================================================================================================================================================
            Installing:
            bind-utils                              x86_64                              32:9.11.4-26.P2.el7_9.14                              updates-openlogic                              262 k

            Transaction Summary
            ========================================================================================================================================================================================
            Install  1 Package

            Total download size: 262 k
            Installed size: 584 k
            Downloading packages:
            bind-utils-9.11.4-26.P2.el7_9.14.x86_64.rpm                                                                                                                      | 262 kB  00:00:00     
            Running transaction check
            Running transaction test
            Transaction test succeeded
            Running transaction
            Installing : 32:bind-utils-9.11.4-26.P2.el7_9.14.x86_64                                                                                                                           1/1 
            Verifying  : 32:bind-utils-9.11.4-26.P2.el7_9.14.x86_64                                                                                                                           1/1 

            Installed:
            bind-utils.x86_64 32:9.11.4-26.P2.el7_9.14                                                                                                                                            

            Complete!
            [admin@linux2 ~]$ yum list installed | grep bind-utils
            bind-utils.x86_64              32:9.11.4-26.P2.el7_9.14       @updates-openlogic
            [admin@linux2 ~]$ 
            ```

        </details>

-->


1. Linux2からWindows Server 2のWebサービスに接続できることを確認する  

    1. コマンドラインで以下のコマンドを実行し、Windows Server 2のWebサービスに接続できることを確認する  
        ＞ ***`wget http://10.X.2.105/web1 --user=Tom --password=Pa\$\$w0rd`***  
        ＞ ***ls***  
        ＞ ***cat web1***  


        > 【補足】  
        > \$記号はBashにおいて特別な効果がある記号文字です。  
        > そのため、パスワード文字列としてそのまま入力することはできません。  
        > \$記号をただの文字として使用するためには、バックスラッシュ(\もしくは￥)記号を付与してエスケープします。   


        ```
        [admin@linux2 ~]$ wget http://10.255.2.105/web1 --user=Tom --password=Pa\$\$w0rd
        --2023-09-25 04:36:58--  http://10.255.2.105/web1
        Connecting to 10.255.2.105:80... connected.
        HTTP request sent, awaiting response... 401 Unauthorized
        Reusing existing connection to 10.255.2.105:80.
        HTTP request sent, awaiting response... 301 Moved Permanently
        Location: http://10.255.2.105/web1/ [following]
        --2023-09-25 04:36:58--  http://10.255.2.105/web1/
        Reusing existing connection to 10.255.2.105:80.
        HTTP request sent, awaiting response... 200 OK
        Length: 133 [text/html]
        Saving to: ‘web1’

        100%[==============================================>] 133         --.-K/s   in 0s      

        2023-09-25 04:36:58 (17.6 MB/s) - ‘web1’ saved [133/133]

        [admin@linux2 ~]$ 
        [admin@linux2 ~]$ ls -l
        total 12
        -rw-rw-r--. 1 admin admin  133 Aug 23 02:52 web1
        [admin@linux2 ~]$ 
        [admin@linux2 ~]$ cat web1
        <html>

        <font size="7">
        Let's HTML document!
        </font>

        <img src="pic.png">

        <a href="document.txt">
        link
        </a>

        </html>

        [admin@linux2 ~]$ 
        ```


         <kbd>![img](image/16/11.png)</kbd>  


1. Linux2からWindows Server 2にDNS問い合わせができることを確認する  

    1. Linux2のコマンドラインのnslookupツールで以下のコマンドを実行し、Windows Server 2に "Web2.example.local." の名前解決要求を送信できることを確認する  
        ＞ ***nslookup***  
        ＞ ***server 10.X.2.105***  
        ＞ ***Web2.example.local.***   
        ＞ ***exit***   

        ```
        [admin@linux2 ~]$
        > server 10.255.2.105
        Default server: 10.255.2.105
        Address: 10.255.2.105#53
        > 
        > Web2.example.local.
        Server:10.255.2.105
        Address:10.255.2.105#53

        Web2.example.localc anonical name = Linux1.example.local.
        Name:Linux1.example.local
        Address: 10.255.1.102
        > 
        > exit
        [admin@linux2 ~]$
        ```


---  

# Router2パケットフィルターを構成する  

<!--
- [x] Linux2(10.X.3.106)からWindows Server 1(10.X.1.104)へのDNS問い合わせを許可する   
- [x] 平日(月~金)は、NW3(10.X.3.0/24)からNW1(10.X.1.0/24)へのアクセスを禁止する   
- [x] 全ホストから、Windows Server 2のWebサービスへのアクセスを許可する   
- [x] これ以外のすべての通信を拒否し、logにカウントする   
-->


1. Router2の管理画面に接続する  


1. ファイアウォール ルール "PACKETFILTER" を作成する 

    1. Router2で以下のコマンドを実行し、CLIモードをConfiguration Modeに変更する   
        ***configure***  

        ```
        trainocatenwadmin@Router2:~$ configure 
        [edit]
        trainocatenwadmin@Router2# 
        ```


    1. Router2で以下のコマンドを実行し、"FILTER"という名前のファイアウォール ルールを定義し、description(説明)を追加する    
        ***set firewall name FILTER description to_learn_advanced_networking***  

        ```
        trainocatenwadmin@Router2# set firewall name FILTER description to_learn_advanced_networking
        [edit]
        trainocatenwadmin@Router2# 
        ```

        > 【補足】  
        > descriptionはデバイスの動作には影響を与えません。  
        > 管理者のための文書として、任意の文字列を記述できます。  

    1. Router2で以下のコマンドを実行し、"FILTER"という名前のファイアウォール ルールが定義されていることを確認する    
        ***show firewall***  

        ```
        trainocatenwadmin@Router2# show firewall 
        +name FILTER {
        +    description to_learn_advanced_networking
        +}
        [edit]
        trainocatenwadmin@Router2# 
        ```

        > 【補足】  
        > この段階では、descriptionのみが記述されています。  
        > 次の手順でファイアウォールの動作を制御するエントリを追加します。    



1. Linux2からWindows Server 1へのDNS通信を許可する  

    1. Router2で以下のコマンドを実行し、Linux2(10.X.3.106)からWindows Server 1(10.X.1.104)へのDNS問い合わせ(UDP 53)を許可(accept)するルールを追加する        
        ***set firewall name FILTER rule 10 action accept***  
        ***set firewall name FILTER rule 10 protocol udp***   
        ***set firewall name FILTER rule 10 source address 10.X.3.106***  
        ***set firewall name FILTER rule 10 destination address 10.X.1.104***  
        ***set firewall name FILTER rule 10 destination port 53***   
        


        ```
        trainocatenwadmin@Router2# set firewall name FILTER rule 10 action accept
        [edit]
        trainocatenwadmin@Router2# set firewall name FILTER rule 10 protocol udp
        [edit]
        trainocatenwadmin@Router2# set firewall name FILTER rule 10 source address 10.255.3.106
        [edit]
        trainocatenwadmin@Router2# set firewall name FILTER rule 10 destination address 10.255.1.104
        [edit]
        trainocatenwadmin@Router2# set firewall name FILTER rule 10 destination port 53
        [edit]
        trainocatenwadmin@Router2# 
        ```

        > 【補足】  
        > 十字キーの上(↑)を押下すると、過去に実行したコマンドの入力を再利用できます。  

    1. Router2で以下のコマンドを実行し、Linux2からWindows Server 1へのDNS問い合わせを許可するルールが追加されていることを確認する      
        ***show firewall***  

        ```
        trainocatenwadmin@Router2# show firewall 
        +name FILTER {
        +    description to_learn_advanced_networking
        +    rule 10 {
        +        action accept
        +        destination {
        +            address 10.255.1.104
        +            port 53
        +        }
        +        protocol udp
        +        source {
        +            address 10.255.3.106
        +        }
        +    }
        +}
        [edit]
        trainocatenwadmin@Router2# 
        ```



1. NW3(10.X.3.0/24)からNW1(10.X.1.0/24)へのアクセスを禁止する 
    1. Router2で以下のコマンドを実行し、NW3(10.X.3.0/24)からNW1(10.X.1.0/24)への通信を禁止(drop)するルールを追加する               
        ***set firewall name FILTER rule 20 action drop***  
        ***set firewall name FILTER rule 20 protocol ip***   
        ***set firewall name FILTER rule 20 source address 10.X.3.0/24***   
        ***set firewall name FILTER rule 20 destination address 10.X.1.0/24***   

        ```
        trainocatenwadmin@Router2# set firewall name FILTER rule 20 action drop  
        [edit]
        trainocatenwadmin@Router2# set firewall name FILTER rule 20 protocol ip  
        [edit]
        trainocatenwadmin@Router2# set firewall name FILTER rule 20 source address 10.255.3.0/24  
        [edit]
        trainocatenwadmin@Router2# set firewall name FILTER rule 20 destination address 10.255.1.0/24  
        [edit]
        trainocatenwadmin@Router2# 
        ```


    1. Router2で以下のコマンドを実行し、NW3(10.X.3.0/24)からNW1(10.X.1.0/24)への通信を禁止するルールが追加されていることを確認する      
        ***show firewall***  

        ```
        trainocatenwadmin@Router2# show firewall 
        +name FILTER {
        +    description to_learn_advanced_networking
        +    rule 10 {
        +        action accept
        +        destination {
        +            address 10.255.1.104
        +            port 53
        +        }
        +        protocol udp
        +        source {
        +            address 10.255.3.106
        +        }
        +    }
        +    rule 20 {
        +        action drop
        +        destination {
        +            address 10.255.1.0/24
        +        }
        +        protocol ip
        +        source {
        +            address 10.255.3.0/24
        +        }
        +    }
        +}
        [edit]
        trainocatenwadmin@Router2# 
        ```





1. Windows Server 2のWebサービスへのアクセスを、全ての送信元IPアドレスに対して許可する  
    1. Router2で以下のコマンドを実行し、全ての送信元IPアドレスからWindows Server 2(10.X.2.105)のWebサービスへのWeb通信(TCP 80 443 1080)を許可(accept)するルールを追加する               
        ***set firewall name FILTER rule 30 action accept***  
        ***set firewall name FILTER rule 30 protocol tcp***  
        ***set firewall name FILTER rule 30 destination address 10.X.2.105***  
        ***set firewall name FILTER rule 30 destination port 80,443,1080***  


        ```
        trainocatenwadmin@Router2# set firewall name FILTER rule 30 action accept
        [edit]
        trainocatenwadmin@Router2# set firewall name FILTER rule 30 protocol tcp
        [edit]
        trainocatenwadmin@Router2# set firewall name FILTER rule 30 destination address 10.255.2.105
        [edit]
        trainocatenwadmin@Router2# set firewall name FILTER rule 30 destination port 80,443,1080
        [edit]
        trainocatenwadmin@Router2# 
        ```

        > 【補足】  
        > Windows Server 2(WinSrv2)のIISでは、TCP80とTCP1080のサービスを現在提供しています。  
        > 後の演習でTCP443番のサービスも提供するように構成します。  
        > TCP443番は、HTTPS通信で使用されます。  

    1. Router2で以下のコマンドを実行し、全ての送信元IPアドレスからWindows Server 2のWebサービスへのWeb通信を許可するルールが追加されていることを確認する      
        ***show firewall***  

        ```
        trainocatenwadmin@Router2# show firewall 
        +name FILTER {
        +    description to_learn_advanced_networking
        +    rule 10 {
        +        action accept
        +        destination {
        +            address 10.255.1.104
        +            port 53
        +        }
        +        protocol udp
        +        source {
        +            address 10.255.3.106
        +        }
        +    }
        +    rule 20 {
        +        action drop
        +        destination {
        +            address 10.255.1.0/24
        +        }
        +        protocol ip
        +        source {
        +            address 10.255.3.0/24
        +        }
        +    }
        +    rule 30 {
        +        action accept
        +        destination {
        +            address 10.255.2.105
        +            port 80,443,1080
        +        }
        +        protocol tcp
        +    }
        +}
        [edit]
        trainocatenwadmin@Router2# 
        ```


1. ここまで条件で許可されなかった残りすべての通信を拒否し、logに記録する   
    1. Router2で以下のコマンドを実行し、ここまでの条件で許可されなかったすべての通信を禁止(drop)してログに記録(log enable)するルールを追加する              
        ***set firewall name FILTER rule 99 action drop***   
        ***set firewall name FILTER rule 99 log enable***  

        ```
        trainocatenwadmin@Router2# set firewall name FILTER rule 99 action drop
        [edit]
        trainocatenwadmin@Router2# set firewall name FILTER rule 99 log enable
        [edit]
        trainocatenwadmin@Router2# 
        ```

    1. Router2で以下のコマンドを実行し、ここまでの条件で許可されなかったすべての通信を禁止してログにカウントするルールが追加されていることを確認する      
        ***show firewall***   


        ```
        trainocatenwadmin@Router2# show firewall 
        +name FILTER {
        +    description to_learn_advanced_networking
        +    rule 10 {
        +        action accept
        +        destination {
        +            address 10.255.1.104
        +            port 53
        +        }
        +        protocol udp
        +        source {
        +            address 10.255.3.106
        +        }
        +    }
        +    rule 20 {
        +        action drop
        +        destination {
        +            address 10.255.1.0/24
        +        }
        +        protocol ip
        +        source {
        +            address 10.255.3.0/24
        +        }
        +    }
        +    rule 30 {
        +        action accept
        +        destination {
        +            address 10.255.2.105
        +            port 80,443,1080
        +        }
        +        protocol tcp
        +    }
        +    rule 99 {
        +        action drop
        +        log enable
        +    }
        +}
        [edit]
        trainocatenwadmin@Router2# 
        ```




---  

# ファイアウォール ルール "FILTER" をインターフェイスに適用し、パケットフィルタを実装する  

1. 以下のコマンドを実行し、eth1 インターフェイスにパケットフィルタを着信方向(in)で適用する    
    ***set firewall interface eth1 in name FILTER***  

    ```
    trainocatenwadmin@Router2# set firewall interface eth1 in name FILTER
    [edit]
    trainocatenwadmin@Router2# 
    ```


1. 以下のコマンドを実行し、eth1 インターフェイスにパケットフィルタを着信方向(in)で適用されていることを確認する   
    ***show firewall interface***  

    ```
    trainocatenwadmin@Router2# show firewall interface 
    +interface eth1 {
    +    in {
    +        name FILTER
    +    }
    +}
    [edit]
    trainocatenwadmin@Router2# 
    ```

1. 以下のコマンドを実行し、設定変更をRunning Configurationに反映(commit)する     
    ***commit***  

    ```
    trainocatenwadmin@Router2# commit
    [edit]
    trainocatenwadmin@Router2# 
    ```

    > 【補足】  
    > この段階では、まだConfigを保存(Save)しません。  
    > パケットフィルターの動作を確認した後に保存します。  



---  

# パケットフィルターの動作を確認する  

1. Linux2の管理画面に接続する  

1. Linux2からWindows Server 2のWebサービスへの通信が成功することを確認する  
    ＞ ***`wget http://10.X.2.105/web1 --user=Tom --password=Pa\$\$w0rd`***  
    ＞ ***ls***  
    ＞ ***cat web1.1***  

    ```
    [admin@linux2 ~]$ wget http://10.255.2.105/web1 --user=Tom --password=Pa\$\$w0rd
    --2023-09-25 08:29:18--  http://10.255.2.105/web1
    Connecting to 10.255.2.105:80... connected.
    HTTP request sent, awaiting response... 401 Unauthorized
    Reusing existing connection to 10.255.2.105:80.
    HTTP request sent, awaiting response... 301 Moved Permanently
    Location: http://10.255.2.105/web1/ [following]
    --2023-09-25 08:29:18--  http://10.255.2.105/web1/
    Reusing existing connection to 10.255.2.105:80.
    HTTP request sent, awaiting response... 200 OK
    Length: 133 [text/html]
    Saving to: ‘web1.1’

    100%[=======================================>] 133         --.-K/s   in 0s      

    2023-09-25 08:29:18 (19.5 MB/s) - ‘web1.1’ saved [133/133]

    [admin@linux2 ~]$ 
    [admin@linux2 ~]$ ls -l
    total 16
    -rw-rw-r--. 1 admin admin 105 Sep  5 15:13 index.html
    -rw-rw-r--. 1 admin admin 133 Aug 23 02:52 web1
    -rw-rw-r--. 1 admin admin 133 Aug 23 02:52 web1.1
    [admin@linux2 ~]$ 
    [admin@linux2 ~]$ cat web1.1
    <html>

    <font size="7">
    Let's HTML document!
    </font>

    <img src="pic.png">

    <a href="document.txt">
    link
    </a>

    </html>

    [admin@linux2 ~]$ 
    ```

    > 【補足】  
    > 以下のルールに該当するため、パケットフィルタで通信が許可されます。    
    > set firewall name FILTER rule 30 action 'accept'  
    > set firewall name FILTER rule 30 destination address '10.255.2.105'  
    > set firewall name FILTER rule 30 destination port '80,443,1080'  
    > set firewall name FILTER rule 30 protocol 'tcp'  

1. Linux2から、Linux1のWebサービスへの通信ができないことを確認する   
    ＞ wget http://10.X.1.102/index.html


    ```
    [admin@linux2 ~]$ wget http://10.255.1.102/index.html
    --2023-09-25 08:19:23--  http://10.255.1.102/index.html
    Connecting to 10.255.1.102:80... failed: No route to host.
    [admin@linux2 ~]$ 
    ```

    > 【補足】  
    > 以下のルールに該当するため、パケットフィルタで通信が禁止(drop)されます。   
    > set firewall name FILTER rule 20 action 'drop'  
    > set firewall name FILTER rule 20 destination address '10.255.1.0/24'  
    > set firewall name FILTER rule 20 protocol 'ip'  
    > set firewall name FILTER rule 20 source address '10.255.3.0/24'  

    > 【補足】  
    > Retryが繰り返され、wget処理の終了に時間がかかる場合があります。   
    > [Ctrl]+[C]で処理を強制終了できます。  



1. Linux2からWindows Server 1にDNS問い合わせができることを確認する  
    1. Linux2のコマンドラインで以下のコマンドを実行し、nslookupツールを開始する  
        ＞ ***nslookup***    

    1. Linux2のコマンドラインのnslookupツールで以下のコマンドを実行し、Windows Server 1に "Web1.example.local." の名前解決要求を送信できることを確認する  
        ＞ ***server 10.X.1.104***  
        ＞ ***Web1.example.local.***   

        ```
        [admin@linux2 ~]$ nslookup
        > server 10.255.1.104
        Default server: 10.255.1.104
        Address: 10.255.1.104#53
        > 
        > Web1.example.local.
        Server:10.255.1.104
        Address:10.255.1.104#53

        Web1.example.local canonical name = WSrv2-230802255.example.local.
        Name:WSrv2-230802255.example.local
        Address: 10.255.2.105
        > 
        ```

        > 【補足】    
        > 以下のルールに該当するため、パケットフィルタで通信が許可されます。    
        > set firewall name FILTER rule 10 action 'accept'  
        > set firewall name FILTER rule 10 destination address '10.255.1.104'  
        > set firewall name FILTER rule 10 destination port '53'  
        > set firewall name FILTER rule 10 protocol 'udp'  
        > set firewall name FILTER rule 10 source address '10.255.3.106'  

1. Linux2からWindows Server 2にDNS問い合わせができないことを確認する  

    1. Linux2のコマンドラインのnslookupツールで以下のコマンドを実行し、Windows Server 2に名前解決要求送信できないことを確認する  
        ＞ ***server 10.X.2.105***  
        ＞ ***Web2.example.local.***   
        ＞ ***exit***   

        ```
        > server 10.255.2.105
        Default server: 10.255.2.105
        Address: 10.255.2.105#53

        > 
        > Web2.example.local.

        ;; connection timed out; no servers could be reached
        > 
        > exit
        [admin@linux2 ~]$
        ```

        > 【補足】  
        > 以下のルールに該当するため、パケットフィルタで通信が禁止(drop)されます。  
        > set firewall name FILTER rule 99 action 'drop'  
        > set firewall name FILTER rule 99 log 'enable'  

        > 【補足】  
        > Router2のファイアウォールのログは、/var/log/messages に保存されます。  
        > Router2で `tail /var/log/messages | grep FILTER` を実行して確認できます。  


---  

# パケットフィルターの設定を保存する    

1. Router2の管理画面に接続する  

1. 以下のコマンドを実行し、Running Configurationを保存(save)する     
    ***save***  

    ```
    trainocatenwadmin@Router2# save
    Saving configuration to '/config/config.boot'...
    Done
    [edit]
    trainocatenwadmin@Router2# 
    ```

1. 以下のコマンドを実行し、Configuration Modeを終了し、CLIモードをOperational Modeに変更する   
    ***exit***  

    ```
    trainocatenwadmin@Router2# exit
    exit
    trainocatenwadmin@Router2:~$ 
    ```


---  

# NAPT(IPマスカレード)を構成する  

1. Router1の管理画面に接続する(注. Router2ではなく、Router1に接続する)   

1. Router1で以下のコマンドを実行し、内部ネットワーク(10.X.1.0/24)の送信元アドレスをeth1インターフェイスのIPアドレス(10.X.2.253)に変換するNAPT(IPマスカレード)を構成する  
    ***configure***  
    ***set nat source rule 10 description 'NAPT for internal network'***  
    ***set nat source rule 10 outbound-interface eth1***  
    ***set nat source rule 10 source address 10.X.1.0/24***  
    ***set nat source rule 10 translation address masquerade***  
    ***show nat***  
    ***commit***  
    ***exit***  

    ```
    trainocatenwadmin@Router1:~$ configure 
    [edit]
    trainocatenwadmin@Router1# set nat source rule 10 description "NAPT for internal network"
    [edit]
    trainocatenwadmin@Router1# set nat source rule 10 outbound-interface eth1
    [edit]
    trainocatenwadmin@Router1# set nat source rule 10 source address 10.255.1.0/24
    [edit]
    trainocatenwadmin@Router1# set nat source rule 10 translation address masquerade 
    [edit]
    trainocatenwadmin@Router1# show nat
    + source {
    +     rule 10 {
    +         description "NAPT for internal network"
    +         outbound-interface eth1
    +         source {
    +             address 10.255.1.0/24
    +         }
    +         translation {
    +             address masquerade
    +         }
    +     }
    + }
    [edit]
    trainocatenwadmin@Router1# commit 
    [edit]
    trainocatenwadmin@Router1# exit
    exit
    trainocatenwadmin@Router1:~$ 
    ```

    > 【補足】  
    > masquerade(マスカレード)は、ルータの1つのIPアドレスを複数のクライアントで共有するオプションです。  
    > NAPT(PAT、IPマスカレード、拡張NATとも)を構成します。  


# NAPTの動作を確認する  

1. ClientのWebブラウザからWebアクセスし、NAPT経由でWebサーバー(Windows Server 2)と通信する      
    1. 操作コンピュータを変更するため、演習環境のトップページに戻る  
    1. Windows Client(WinClient)の管理画面に "admin" で接続する   
    1. WinClientでWebブラウザ(Google Chrome)を起動する  
    1. Webブラウザのアドレス欄に [http://Web1.example.local/web1] と入力し、[Enter]キーを押下する  
    1. 認証情報を入力するポップアップが表示されたことを確認する  
    1. 以下のパラメータを入力する  
        | 項目 | パラメータ |  
        | :----- | :----- |  
        | ユーザー名 | Tom |   
        | パスワード | Pa$$w0rd |   
    1. 上のパラメータを入力し、[ログイン]をクリックする  
    1. Webコンテンツにアクセスできることを確認する  


1. Windows Server 1のWebブラウザからWebアクセスし、NAPT経由でWebサーバー(Windows Server 2)と通信する      
    1. 操作コンピュータを変更するため、演習環境のトップページに戻る  
    1. Windows Server 1(WinSrv1)の管理画面に "admin" で接続する   
    1. WinSrv1(Google Chrome)を起動する  
    1. Webブラウザのアドレス欄に [http://Web1.example.local/web1] と入力し、[Enter]キーを押下する  
    1. 認証情報を入力するポップアップが表示されたことを確認する  
    1. 以下のパラメータを入力する  
        | 項目 | パラメータ |  
        | :----- | :----- |  
        | ユーザー名 | Jerry |   
        | パスワード | Pa$$w0rd |   
    1. 上のパラメータを入力し、[ログイン]をクリックする  
    1. Webコンテンツにアクセスできることを確認する  

1. Router1でアドレス変換の記録を確認する  
    1. 操作コンピュータを変更するため、演習環境のトップページに戻る  
    1. Router1の管理画面に接続する  
    1. Router1で以下のコマンドを実行してアドレス変換テーブルを表示し、WinClientとWinSrv1のアドレスがRouter1のeth1のIPアドレス(10.X.2.253)に変換されていることを確認する      
        ***show nat source translations***  

        ```  
        trainocatenwadmin@Router1:~$ show nat source translations 
        Pre-NAT             Post-NAT            Proto    Timeout    Mark    Zone
        ------------------  ------------------  -------  ---------  ------  ------
        10.255.1.104:50595  10.255.2.253:50595  tcp      431995     0
        10.255.1.103:50142  10.255.2.253:50142  tcp      431997     0
        10.255.1.104:50594  10.255.2.253:50594  tcp      431995     0
        10.255.1.103:50143  10.255.2.253:50143  tcp      431997     0
        trainocatenwadmin@Router1:~$ 
        ```  

1. Webサーバー(WinSrv2)のアクセスログを確認し、接続してきたクライアントの送信元IPアドレスが変換されていることを確認する  
    1. 操作コンピュータを変更するため、演習環境のトップページに戻る  
    1. Windows Server 2(WinSrv2)の管理画面に "admin" で接続する   
    1. "C:\\inetpub\\logs\\LogFiles\\W3SV1" フォルダを開く  
    1. logファイルを確認する  
        <kbd>![img](image/16/32.png)</kbd>   

        > 【確認ポイント】  
        > WinClientとWinSrv1が、1つのIPアドレス共用するNAPTを経てWebサーバー(Windows Server 2)と通信していることを確認する  
        > - [x] WinClient(Tom)の送信元IPアドレスが、10.X.2.253であること
        > - [x] WinSrv1(Jerry)の送信元IPアドレスが、10.X.2.253であること


> 【補足】  
> 送信元IPアドレスを変換するNAPT(IPマスカレード)は、プライベートIPアドレスが設定された社内ネットワークの多数のクライアントコンピューターが、少数のグローバルIPアドレスを共用してインターネットにアクセスするために多用されます。  



---  

# DNAT(宛先アドレス変換)を構成する

1. Router1の管理画面に接続する  

1. Router1で以下のコマンドを実行し、eth1インターフェイスに着信するTCP8080番を宛先としたパケットの宛先IPアドレスを、Linux1(10.X.1.102)のIPアドレスに変換するDestination NATを構成する  
    ***configure***  
    ***set nat destination rule 10 description 'Forward TCP port 8080 to Linux Web'***  
    ***set nat destination rule 10 destination port 8080***  
    ***set nat destination rule 10 inbound-interface eth1***  
    ***set nat destination rule 10 protocol tcp***  
    ***set nat destination rule 10 translation address 10.X.1.102***  
    ***set nat destination rule 10 translation port 80***  
    ***show nat***  
    ***commit***  
    ***exit***  

    ```
    trainocatenwadmin@Router1:~$ configure 
    [edit]
    trainocatenwadmin@Router1# set nat destination rule 10 description 'Forward TCP port 8080 to Linux Web'
    [edit]
    trainocatenwadmin@Router1# set nat destination rule 10 destination port 8080
    [edit]
    trainocatenwadmin@Router1# set nat destination rule 10 inbound-interface eth1
    [edit]
    trainocatenwadmin@Router1# set nat destination rule 10 protocol tcp
    [edit]
    trainocatenwadmin@Router1# set nat destination rule 10 translation address 10.255.1.102
    [edit]
    trainocatenwadmin@Router1# set nat destination rule 10 translation port 80
    [edit]
    trainocatenwadmin@Router1#
    trainocatenwadmin@Router1# show nat 
    +destination {
    +    rule 10 {
    +        description "Forward TCP port 80 to Linux Web"
    +        destination {
    +            port 8080
    +        }
    +        inbound-interface eth1
    +        protocol tcp
    +        translation {
    +            address 10.255.1.102
    +            port 80
    +        }
    +    }
    +}
    source {
        rule 10 {
            description "NAPT for internal network"
            outbound-interface eth1
            source {
                address 10.255.1.0/24
            }
            translation {
                address masquerade
            }
        }
    }
    [edit]
    trainocatenwadmin@Router1# commit 
    [edit]
    trainocatenwadmin@Router1# exit
    exit
    trainocatenwadmin@Router1:~$ 
    ```

# DNAT(宛先アドレス変換)の動作を確認する  

1. Windows Server 2のWebブラウザからRouter1のeth1のIPアドレス(10.X.2.253)にアクセスし、DNAT経由でLinux Webサーバー(Linux1)と通信する      
    1. 操作コンピュータを変更するため、演習環境のトップページに戻る  
    1. Windows Server 2(WinSrv2)の管理画面に接続する   
    1. WinSrv2でWebブラウザ(Google Chrome)を起動する  
    1. Webブラウザのアドレス欄に [http://10.X.2.253:8080] と入力し、[Enter]キーを押下する  
    1. Linux 1のWebコンテンツにアクセスできることを確認する  

1. Router1でアドレス変換の記録を確認する  
    1. 操作コンピュータを変更するため、演習環境のトップページに戻る  
    1. Router1の管理画面に接続する  
    1. Router1で以下のコマンドを実行してアドレス変換テーブルを表示し、Router1のeth1のIPアドレス(10.X.2.253)のTCP8080番宛のパケットの宛先IPアドレスが、Linux1(10.X.1.102)のTCP80番宛に変換されていることを確認する      
        ***show nat destination translations***  

        ```  
        trainocatenwadmin@Router1:~$ show nat destination translations 
        Pre-NAT            Post-NAT         Proto    Timeout    Mark    Zone
        -----------------  ---------------  -------  ---------  ------  ------
        10.255.2.253:8080  10.255.1.102:80  tcp      431959     0
        10.255.2.253:8080  10.255.1.102:80  tcp      431959     0
        trainocatenwadmin@Router1:~$ 
        ```  



> 【補足】  
> DNAT(宛先アドレス変換)は、プライベートIPアドレスが設定された社内ネットワークのサーバーをインターネットに公開する際に多用されます。  

> 【補足】  
> パケットのアドレスを変換する条件は、"eth1でinbound(着信方向)で受信" した "宛先ポートがTCP8080" であることだけです。   
> そのため、http://10.X.1.102:8080 や http://10.X.1.104:8080 のURLを宛先としても、10.X.1.102:80 を宛先にしたアドレスに変換されてWebアクセスに成功します。  


---


# NATの構成を削除する  

> 【補足】  
> NAT処理が演習環境で動作する一部のサービスの正常な動作を妨げる場合があります。  
> 後の演習を円滑に進めるために、NATの動作を確認して学習に区切りをつけた後、NAT構成を削除します。  


1. Router1の管理画面に接続する  

1. Router1で以下のコマンドを実行し、eth1インターフェイスに着信するTCP8080番を宛先としたパケットの宛先IPアドレスを、Linux1(10.X.1.102)のIPアドレスに変換するDestination NATを構成する  
    ***configure***  
    ***delete nat source rule 10***  
    ***delete nat destination rule 10***  
    ***show nat***  
    ***commit***  
    ***show nat***  
    ***exit***  

    ```  
    trainocatenwadmin@Router1:~$ configure 
    [edit]
    trainocatenwadmin@Router1# delete nat source rule 10
    [edit]
    trainocatenwadmin@Router1# delete nat destination rule 10
    [edit]
    trainocatenwadmin@Router1# show nat
    destination {
    -    rule 10 {
    -        description "Forward TCP port 80 to Linux Web"
    -        destination {
    -            port 80
    -        }
    -        inbound-interface eth1
    -        protocol tcp
    -        translation {
    -            address 10.255.1.102
    -            port 80
    -        }
    -    }
    }
    source {
    -    rule 10 {
    -        description "NAPT for internal network"
    -        outbound-interface eth1
    -        source {
    -            address 10.255.1.0/24
    -        }
    -        translation {
    -            address masquerade
    -        }
    -    }
    }
    [edit]
    trainocatenwadmin@Router1# commit
    [edit]
    trainocatenwadmin@Router1# show nat
    destination {
    }
    source {
    }
    [edit]
    trainocatenwadmin@Router1# exit
    Warning: configuration changes have not been saved.
    exit
    trainocatenwadmin@Router1:~$ 
    ```  

---  


# 静的ルーティングを削除する

> 【補足】  
> これからダイナミック ルーティングを学習するために、既存のスタティック ルーティングの設定を削除します。

1. Router1のStatic Routeを削除する  
    1. Router1の管理画面に接続する 

    1. Router1のOperational Mode(プロンプトの右端が$記号)で以下のコマンドを実行し、現在のルーティング テーブルを確認する    
        ***show ip route***

        ```
        trainocatenwadmin@Router1:~$ show ip route
        Codes: K - kernel route, C - connected, S - static, R - RIP,
            O - OSPF, I - IS-IS, B - BGP, E - EIGRP, N - NHRP,
            T - Table, v - VNC, V - VNC-Direct, A - Babel, F - PBR,
            f - OpenFabric,
            > - selected route, * - FIB route, q - queued, r - rejected, b - backup
            t - trapped, o - offload failure

        K>* 0.0.0.0/0 [0/0] via 10.255.1.1, eth0, 03:17:58
        S   0.0.0.0/0 [210/0] via 10.0.0.1, eth0 inactive, weight 1, 03:18:51
        C>* 10.255.1.0/24 is directly connected, eth0, 03:18:52
        C>* 10.255.2.0/24 is directly connected, eth1, 03:18:54
        S>* 10.255.3.0/24 [1/0] via 10.255.2.254, eth1, weight 1, 03:18:51
        trainocatenwadmin@Router1:~$ 
        ```

        > 【確認ポイント】  
        > 10.X.3.0/24ネットワーク宛のルーティング情報として、Router2(10.X.2.254)をNextHopとするStatic Routeが認識されていることを確認する  

    1. Router1で以下のコマンドを実行し、スタティックルーティングの設定を削除する
        ***configure***  
        ***delete protocols static route 10.X.3.0/24***  
        ***show protocols***  
        ***commit***  
        ***show protocols***  
        ***save***  
        ***exit***  

        ```
        trainocatenwadmin@Router1:~$ configure 
        [edit]
        trainocatenwadmin@Router1# delete protocols static route 10.255.3.0/24
        [edit]
        trainocatenwadmin@Router1# show protocols 
        static {
        -    route 10.255.3.0/24 {
        -        next-hop 10.255.2.254 {
        -            interface eth1
        -        }
        -    }
        }
        [edit]
        trainocatenwadmin@Router1# 
        trainocatenwadmin@Router1# commit
        [edit]
        trainocatenwadmin@Router1# show protocols 
        static {
        }
        [edit]
        trainocatenwadmin@Router1# 
        trainocatenwadmin@Router1# save
        Saving configuration to '/config/config.boot'...
        Done
        [edit]
        trainocatenwadmin@Router1# exit
        exit
        trainocatenwadmin@Router1:~$ 
        ```

    1. Router1で以下のコマンドを実行し、ルーティング テーブルから10.X.3.0/24の経路情報が削除されていることを確認する      
        ***show ip route***

        ```
        trainocatenwadmin@Router1:~$ show ip route
        Codes: K - kernel route, C - connected, S - static, R - RIP,
            O - OSPF, I - IS-IS, B - BGP, E - EIGRP, N - NHRP,
            T - Table, v - VNC, V - VNC-Direct, A - Babel, F - PBR,
            f - OpenFabric,
            > - selected route, * - FIB route, q - queued, r - rejected, b - backup
            t - trapped, o - offload failure

        S   0.0.0.0/0 [210/0] via 10.1.1.1, eth0 inactive, weight 1, 00:03:16
        K>* 0.0.0.0/0 [0/0] via 10.255.1.1, eth0, 04:40:54
        C>* 10.255.1.0/24 is directly connected, eth0, 04:41:48
        C>* 10.255.2.0/24 is directly connected, eth1, 04:41:50
        trainocatenwadmin@Router1:~$ 
        ```

        > 【確認ポイント】  
        > 10.X.3.0/24ネットワーク宛のルーティング エントリが存在しないこと(削除されたこと)を確認する



1. Router2のStatic Routeを削除する  
    1. Router2の管理画面に接続する 

    1. Router2のOperational Mode(プロンプトの右端が$記号)で以下のコマンドを実行し、現在のルーティング テーブルを確認する    
        ***show ip route***

        ```
        trainocatenwadmin@Router2:~$ show ip route
        Codes: K - kernel route, C - connected, S - static, R - RIP,
            O - OSPF, I - IS-IS, B - BGP, E - EIGRP, N - NHRP,
            T - Table, v - VNC, V - VNC-Direct, A - Babel, F - PBR,
            f - OpenFabric,
            > - selected route, * - FIB route, q - queued, r - rejected, b - backup
            t - trapped, o - offload failure

        K>* 0.0.0.0/0 [0/0] via 10.255.2.1, eth0, 04:49:18
        S   0.0.0.0/0 [210/0] via 10.1.1.1, eth0 inactive, weight 1, 04:50:11
        S>* 10.255.1.0/24 [1/0] via 10.255.2.253, eth0, weight 1, 04:50:11
        C>* 10.255.2.0/24 is directly connected, eth0, 04:50:16
        C>* 10.255.3.0/24 is directly connected, eth1, 04:50:16
        trainocatenwadmin@Router2:~$ 
        ```

        > 【確認ポイント】  
        > 10.X.1.0/24ネットワーク宛のルーティング情報として、Router1(10.X.2.253)をNextHopとするStatic Routeが認識されていることを確認する  

    1. Router2で以下のコマンドを実行し、スタティックルーティングの設定を削除する
        ***configure***  
        ***delete protocols static route 10.X.1.0/24***  
        ***show protocols***  
        ***commit***  
        ***show protocols***  
        ***save***  
        ***exit***  

        ```
        trainocatenwadmin@Router2:~$ configure 
        [edit]
        trainocatenwadmin@Router2# delete protocols static route 10.255.1.0/24
        [edit]
        trainocatenwadmin@Router2# show protocols 
        static {
        -    route 10.255.1.0/24 {
        -        next-hop 10.255.2.253 {
        -            interface eth0
        -        }
        -    }
        }
        [edit]
        trainocatenwadmin@Router2# commit
        [edit]
        trainocatenwadmin@Router2# show protocols 
        static {
        }
        [edit]
        trainocatenwadmin@Router2# save
        Saving configuration to '/config/config.boot'...
        Done
        [edit]
        trainocatenwadmin@Router2# exit
        exit
        trainocatenwadmin@Router2:~$ 
        ```

    1. Router2で以下のコマンドを実行し、ルーティング テーブルから10.X.1.0/24の経路情報が削除されていることを確認する      
        ***show ip route***

        ```
        trainocatenwadmin@Router2:~$ show ip route
        Codes: K - kernel route, C - connected, S - static, R - RIP,
            O - OSPF, I - IS-IS, B - BGP, E - EIGRP, N - NHRP,
            T - Table, v - VNC, V - VNC-Direct, A - Babel, F - PBR,
            f - OpenFabric,
            > - selected route, * - FIB route, q - queued, r - rejected, b - backup
            t - trapped, o - offload failure

        K>* 0.0.0.0/0 [0/0] via 10.255.2.1, eth0, 04:50:57
        S   0.0.0.0/0 [210/0] via 10.1.1.1, eth0 inactive, weight 1, 04:51:50
        C>* 10.255.2.0/24 is directly connected, eth0, 04:51:55
        C>* 10.255.3.0/24 is directly connected, eth1, 04:51:55
        trainocatenwadmin@Router2:~$ 
        ```

        > 【確認ポイント】  
        > 10.X.1.0/24ネットワーク宛のルーティング エントリが存在しないこと(削除されたこと)を確認する




1. 10.X.1.0/24と10.X.3.0/24の通信ができないことを確認する    
    1. Router2の管理画面に接続する

    1. Router2で以下のコマンドを実行し、10.X.1.0/24と10.X.3.0/24の通信ができないことを確認する          
        ***ping 10.X.1.254 source-address 10.X.3.254 count 4***

        ```
        trainocatenwadmin@Router2:~$ ping 10.255.1.254 source-address 10.255.3.254 count 4
        PING 10.255.1.254 (10.255.1.254) from 10.255.3.254 : 56(84) bytes of data.

        --- 10.255.1.254 ping statistics ---
        4 packets transmitted, 0 received, 100% packet loss, time 3051ms

        trainocatenwadmin@Router2:~$ 
        ```

<!--
> 【補足】  
> Azureが暗黙的に作成する0.0.0.0/0により、source-addressを指定しない10.X.1.0/24と10.X.3.0/24間のpingは成功します。    
-->







1. BGPプロセスを開始する  
    1. Router1の管理画面に接続する  
    1. Router1で以下のコマンドを実行し、AS番号 65001 としてBGPプロセスをRouter-ID 10.X.100.1で開始する  
        ***configure***  
        ***set protocols bgp system-as 65001***  
        ***set protocols bgp parameters router-id 10.X.100.1***  
        ***show protocols bgp***  
        ***commit***  

        ```
        trainocatenwadmin@Router1:~$ configure 
        [edit]
        trainocatenwadmin@Router1# set protocols bgp system-as 65001
        [edit]
        trainocatenwadmin@Router1# set protocols bgp parameters router-id 10.255.100.1
        [edit]
        trainocatenwadmin@Router1# show protocols bgp
        +parameters {
        +    router-id 10.255.100.1
        +}
        +system-as 65001
        [edit]
        trainocatenwadmin@Router1# commit
        [edit]
        trainocatenwadmin@Router1# 
        ```

    1. Router2の管理画面に接続する  

    1. Router2で以下のコマンドを実行し、AS番号 65002 としてBGPプロセスをRouter-ID 10.X.100.2で開始する  
        ***configure***  
        ***set protocols bgp system-as 65002***  
        ***set protocols bgp parameters router-id 10.X.100.2***  
        ***show protocols bgp***  
        ***commit***  

        ```
        trainocatenwadmin@Router2:~$ configure 
        [edit]
        trainocatenwadmin@Router2# set protocols bgp system-as 65002
        [edit]
        trainocatenwadmin@Router2# set protocols bgp parameters router-id 10.255.100.2
        [edit]
        trainocatenwadmin@Router2# show protocols bgp
        +parameters {
        +    router-id 10.255.100.2
        +}
        +system-as 65002
        [edit]
        trainocatenwadmin@Router2# commit
        [edit]
        trainocatenwadmin@Router2# 
        ```




1. BGPネイバーを確立する  
    1. Router1の管理画面に接続する  
    1. Router1で以下のコマンドを実行し、IPv4経路を交換するBGPネイバーとして、AS番号65002のRouter2(10.X.2.254)を指定する      
        ***set protocols bgp neighbor 10.X.2.254 description 'Router 2 in AS 65002'***  
        ***set protocols bgp neighbor 10.X.2.254 remote-as 65002***  
        ***set protocols bgp neighbor 10.X.2.254 address-family ipv4-unicast***  
        ***show protocols bgp***  
        ***commit***  

        ```  
        trainocatenwadmin@Router1# set protocols bgp neighbor 10.255.2.254 description 'Router 2 in AS 65002'
        [edit]
        trainocatenwadmin@Router1# set protocols bgp neighbor 10.255.2.254 remote-as 65002
        [edit]
        trainocatenwadmin@Router1# set protocols bgp neighbor 10.255.2.254 address-family ipv4-unicast 
        [edit]
        trainocatenwadmin@Router1# show protocols bgp
        +neighbor 10.255.2.254 {
        +    address-family {
        +        ipv4-unicast {
        +        }
        +    }
        +    description "Router 2 in AS 65002"
        +    remote-as 65002
        +}
        parameters {
            router-id 10.255.100.1
        }
        system-as 65001
        [edit]
        trainocatenwadmin@Router1# commit
        [edit]
        trainocatenwadmin@Router1# 
        ```  

    1. Router1で以下のコマンドを実行し、BGPネイバーのステータスを確認する  
        ***exit***  
        ***show bgp summary***  

        > 【補足】  
        > Router2のconfigが完了していないため、この時点ではまだBGPネイバーを確立できません。  
        > Up/Downがneverであることを確認してください。  


        ```
        trainocatenwadmin@Router1# exit
        Warning: configuration changes have not been saved.
        exit
        trainocatenwadmin@Router1:~$ show bgp summary 

        IPv4 Unicast Summary (VRF default):
        BGP router identifier 10.255.100.1, local AS number 65001 vrf-id 0
        BGP table version 0
        RIB entries 0, using 0 bytes of memory
        Peers 1, using 723 KiB of memory

        Neighbor        V         AS   MsgRcvd   MsgSent   TblVer  InQ OutQ  Up/Down State/PfxRcd   PfxSnt Desc
        10.255.2.254    4      65002         0         1        0    0    0    never       Active        0 Router 2 in AS 65002

        Total number of neighbors 1
        trainocatenwadmin@Router1:~$ 
        ```

        > 【確認ポイント】  
        > Router2をBGPネイバーとして指定するパラメータが正しいことを確認する  
        > - [x] NeighborのIPアドレスが、Router2のIPアドレスであること  
        > - [x] AS番号が 65002 であること  
        > - [x] Up/Downがneverであること  


    1. Router2の管理画面に接続する  

    1. Router2で以下のコマンドを実行し、IPv4経路を交換するBGPネイバーとして、AS番号65001のRouter1(10.X.2.253)を指定する      
        ***set protocols bgp neighbor 10.X.2.253 description 'Router 1 in AS 65001'***  
        ***set protocols bgp neighbor 10.X.2.253 remote-as 65001***  
        ***set protocols bgp neighbor 10.X.2.253 address-family ipv4-unicast***  
        ***show protocols bgp***  
        ***commit***  

        ```  
        trainocatenwadmin@Router2# set protocols bgp neighbor 10.255.2.253 description 'Router 1 in AS 65001'
        [edit]
        trainocatenwadmin@Router2# set protocols bgp neighbor 10.255.2.253 remote-as 65001
        [edit]
        trainocatenwadmin@Router2# set protocols bgp neighbor 10.255.2.253 address-family ipv4-unicast 
        [edit]
        trainocatenwadmin@Router2# show protocols bgp
        +neighbor 10.255.2.253 {
        +    address-family {
        +        ipv4-unicast {
        +        }
        +    }
        +    description "Router 1 in AS 65001"
        +    remote-as 65001
        +}
        parameters {
            router-id 10.255.100.2
        }
        system-as 65002
        [edit]
        trainocatenwadmin@Router2# commit
        [edit]
        trainocatenwadmin@Router2# 
        ```  

    1. Router2で以下のコマンドを実行し、BGPネイバーのステータスを確認する  
        ***exit***  
        ***show bgp summary***  

        > 【補足】  
        > Router1とRouter2の双方のconfigが完了したため、BGPネイバーが確立されています。    
        > Up/Down列にBGPネイバー確立後の経過時間が表記されていることを確認してください。    

        ```
        trainocatenwadmin@Router2# exit
        Warning: configuration changes have not been saved.
        exit
        trainocatenwadmin@Router2:~$ show bgp summary 

        IPv4 Unicast Summary (VRF default):
        BGP router identifier 10.255.100.2, local AS number 65002 vrf-id 0
        BGP table version 0
        RIB entries 0, using 0 bytes of memory
        Peers 1, using 723 KiB of memory

        Neighbor        V         AS   MsgRcvd   MsgSent   TblVer  InQ OutQ  Up/Down State/PfxRcd   PfxSnt Desc
        10.255.2.253    4      65001         3         3        0    0    0 00:00:26            0        0 Router 1 in AS 65001

        Total number of neighbors 1
        trainocatenwadmin@Router2:~$ 
        ```
        > 【確認ポイント】  
        > Router1をBGPネイバーとして指定するパラメータが正しいことを確認する  
        > - [x] NeighborのIPアドレスが、Router1のIPアドレスであること  
        > - [x] AS番号が 65001 であること  
        > - [x] Up/Downにネイバー確立後の経過時間が表示されていること    

    1. Router1の管理画面に接続する  

    1. Router1で以下のコマンドを実行し、BGPネイバーのステータスを確認する  
        ***show bgp summary***

        > 【補足】  
        > Router1でshow bgp summaryコマンドを実行しても、BGPネイバーが確立された状態になっていることを確認できます。      
        > Up/Down列にBGPネイバー確立後の経過時間が表記されていることを確認してください。    

        ```
        trainocatenwadmin@Router1:~$ show bgp summary 

        IPv4 Unicast Summary (VRF default):
        BGP router identifier 10.255.100.1, local AS number 65001 vrf-id 0
        BGP table version 0
        RIB entries 0, using 0 bytes of memory
        Peers 1, using 723 KiB of memory

        Neighbor        V         AS   MsgRcvd   MsgSent   TblVer  InQ OutQ  Up/Down State/PfxRcd   PfxSnt Desc
        10.255.2.254    4      65002         5        10        0    0    0 00:02:05            0        0 Router 2 in AS 65002

        Total number of neighbors 1
        trainocatenwadmin@Router1:~$ 
        ```

        > 【確認ポイント】  
        > Router2とBGPネイバーを確立できていることを確認する    
        > - [x] Up/Downにネイバー確立後の経過時間が表示されていること    



1. BGPで経路をアドバタイズする  

    1. Router1の管理画面に接続する  

    1. Router1で以下のコマンドを実行し、10.X.1.0/24をBGPネイバーにアドバタイズするように指定する   
        ***configure***  
        ***set protocols bgp address-family ipv4-unicast network 10.X.1.0/24***  
        ***show protocols bgp***  
        ***commit***  
        ***save***  

        ```
        trainocatenwadmin@Router1:~$ configure 
        [edit]
        trainocatenwadmin@Router1# set protocols bgp address-family ipv4-unicast network 10.255.1.0/24
        [edit]
        trainocatenwadmin@Router1# show protocols bgp
        +address-family {
        +    ipv4-unicast {
        +        network 10.255.1.0/24 {
        +        }
        +    }
        +}
        neighbor 10.255.2.254 {
            address-family {
                ipv4-unicast {
                }
            }
            description "Router 2 in AS 65002"
            remote-as 65002
        }
        parameters {
            router-id 10.255.100.1
        }
        system-as 65001
        [edit]
        trainocatenwadmin@Router1# commit
        [edit]
        trainocatenwadmin@Router1# save
        Saving configuration to '/config/config.boot'...
        Done
        [edit]
        trainocatenwadmin@Router1# 
        ```

    1. Router2の管理画面に接続する  

    1. Router2で以下のコマンドを実行し、Router1からアドバタイズされた経路情報がルーティンテーブルに存在することを確認する    
        ***show ip route**  

        > 【補足】  
        > エントリ行の左端のアルファベットは、経路の学習方法を示します。  
        > BはBGPを意味します。
        > 10.X.1.0/24の経路をBGPで学習していることを確認してください。  

        ```
        trainocatenwadmin@Router2:~$ show ip route
        Codes: K - kernel route, C - connected, S - static, R - RIP,
            O - OSPF, I - IS-IS, B - BGP, E - EIGRP, N - NHRP,
            T - Table, v - VNC, V - VNC-Direct, A - Babel, F - PBR,
            f - OpenFabric,
            > - selected route, * - FIB route, q - queued, r - rejected, b - backup
            t - trapped, o - offload failure

        K>* 0.0.0.0/0 [0/0] via 10.255.2.1, eth0, 01:40:39
        S   0.0.0.0/0 [210/0] via 10.1.1.1, eth0 inactive, weight 1, 01:41:32
        B>* 10.255.1.0/24 [20/0] via 10.255.2.253, eth0, weight 1, 00:04:28
        C>* 10.255.2.0/24 is directly connected, eth0, 01:41:33
        C>* 10.255.3.0/24 is directly connected, eth1, 01:41:37
        trainocatenwadmin@Router2:~$ 
        ```

        > 【確認ポイント】  
        > 10.X.1.0/24のNWの情報がRouter2にアドバタイズされていることを確認する   
        > - [x] 10.X.1.0/24の経路情報が表示されていること  
        > - [x] Nexthop(via)が、Router1のeth1(10.X.2.253)であること 

    1. Router2で以下のコマンドを実行し、10.X.3.0/24をBGPネイバーにアドバタイズするように指定する   
        ***configure***  
        ***set protocols bgp address-family ipv4-unicast network 10.X.3.0/24***  
        ***show protocols bgp***  
        ***commit***  
        ***save*** 

        ```
        trainocatenwadmin@Router2:~$ configure 
        [edit]
        trainocatenwadmin@Router2# set protocols bgp address-family ipv4-unicast network 10.255.3.0/24
        [edit]
        trainocatenwadmin@Router2# show protocols bgp
        +address-family {
        +    ipv4-unicast {
        +        network 10.255.3.0/24 {
        +        }
        +    }
        +}
        neighbor 10.255.2.253 {
            address-family {
                ipv4-unicast {
                }
            }
            description "Router 1 in AS 65001"
            remote-as 65001
        }
        parameters {
            router-id 10.255.100.2
        }
        system-as 65002
        [edit]
        trainocatenwadmin@Router2# commit
        [edit]
        trainocatenwadmin@Router2# save
        Saving configuration to '/config/config.boot'...
        Done
        [edit]
        trainocatenwadmin@Router2# 
        ``` 

    1. Router1の管理画面に接続する  

    1. Router1で以下のコマンドを実行し、Router2からアドバタイズされた経路情報がルーティンテーブルに存在することを確認する    
        ***exit***   
        ***show ip route***  

        > 【補足】  
        > 10.X.3.0/24の経路をBGPで学習していることを確認してください。  

        ```
        trainocatenwadmin@Router1# exit
        Warning: configuration changes have not been saved.
        exit
        trainocatenwadmin@Router1:~$ show ip route
        Codes: K - kernel route, C - connected, S - static, R - RIP,
            O - OSPF, I - IS-IS, B - BGP, E - EIGRP, N - NHRP,
            T - Table, v - VNC, V - VNC-Direct, A - Babel, F - PBR,
            f - OpenFabric,
            > - selected route, * - FIB route, q - queued, r - rejected, b - backup
            t - trapped, o - offload failure

        S   0.0.0.0/0 [210/0] via 10.0.0.1, eth0 inactive, weight 1, 01:46:29
        K>* 0.0.0.0/0 [0/0] via 10.255.1.1, eth0, 01:46:33
        C>* 10.255.1.0/24 is directly connected, eth0, 01:46:35
        C>* 10.255.2.0/24 is directly connected, eth1, 01:46:31
        B>* 10.255.3.0/24 [20/0] via 10.255.2.254, eth1, weight 1, 00:00:26
        trainocatenwadmin@Router1:~$ 
        ```
        
        > 【確認ポイント】  
        > 10.X.3.0/24のNWの情報がRouter1にアドバタイズされていることを確認する   
        > - [x] 10.X.3.0/24の経路情報が表示されていること  
        > - [x] Nexthop(via)が、Router2のeth0(10.X.2.254)であること 

# リモートネットワーク間の疎通を確認する  

1. Router1の管理画面に接続する  

1. Router1で以下のコマンドを実行し、リモートネットワーク間(10.X.1.0/24と10.X.3.0/24間)で通信できることを確認する      
    ***ping 10.X.3.254 source-address 10.X.1.254 count 4***  

    ```
    trainocatenwadmin@Router1:~$ ping 10.255.3.254 source-address 10.255.1.254 count 4
    PING 10.255.3.254 (10.255.3.254) from 10.255.1.254 : 56(84) bytes of data.
    64 bytes from 10.255.3.254: icmp_seq=1 ttl=64 time=1.43 ms
    64 bytes from 10.255.3.254: icmp_seq=2 ttl=64 time=1.25 ms
    64 bytes from 10.255.3.254: icmp_seq=3 ttl=64 time=1.70 ms
    64 bytes from 10.255.3.254: icmp_seq=4 ttl=64 time=1.65 ms

    --- 10.255.3.254 ping statistics ---
    4 packets transmitted, 4 received, 0% packet loss, time 3005ms
    rtt min/avg/max/mdev = 1.251/1.507/1.703/0.180 ms
    trainocatenwadmin@Router1:~$ 
    ```

    > 【確認ポイント】  
    > 10.X.1.254と10.X.3.254の間でping疎通が確立できることを確認する   
    > - [x] pingコマンドの実行結果として、time=に応答所要時間(ミリ秒)が記載されていること  



---  

# 演習完了  
ここまでの手順で、以下の項目を学習できました。
- [x] パケットフィルタを実装する  
- [x] アドレス変換(NAPT, DNAT)を構成する  
- [x] リモートルーターとBGPピアリングを構成する  
- [x] networkコマンドでBGPルートを生成し、BGPネイバーにアドバタイズする
